name: Rust Cross-Compilation for Termux (AArch64)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build_termux:
    name: Build for Termux (AArch64)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain and target
      uses: dtolnay/rust-toolchain@stable
      with: {targets: aarch64-linux-android}
        
    - name: Clean and Build Rust binary using Cross
      id: build_step
      run: |
        echo "Forcing a clean build to bypass potential caching/skip issues."
        cross clean --target aarch64-linux-android
        cross build --release --target aarch64-linux-android -vvv 2>&1 | tee build_log.txt
      continue-on-error: true

    - name: Debug: List Build Output Path
      run: |
        echo "Listing contents of target/aarch64-linux-android/release/:"
        ls -lR target/aarch64-linux-android/release/

    - name: Enforce Binary Existence and Fail
      run: |
        FINAL_PATH="target/aarch64-linux-android/release/cyber_lookup"
        if [ ! -f "$FINAL_PATH" ]; then
          echo "âŒ Binary NOT found at expected path: $FINAL_PATH"
          echo "The build was likely skipped or failed to output the file. Review the full build_log.txt."
          exit 1 
        fi
        echo "âœ… Binary found at: $FINAL_PATH"

    - name: Summarize and Highlight Errors (Automated Analysis)
      if: failure()
      run: |
        echo "--- ðŸš¨ äº¤å‰ç¼–è¯‘é”™è¯¯æ‘˜è¦ ðŸš¨ ---" >> $GITHUB_STEP_SUMMARY
        echo "## é‡ç‚¹é”™è¯¯æç‚¼" >> $GITHUB_STEP_SUMMARY
        
        grep -E 'error:|note:|failed:|cannot find|undefined reference|linker|collect2|aarch64-linux-android' build_log.txt \
        | head -n 50 \
        | sed 's/^/- /' \
        >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "--- å®Œæ•´é”™è¯¯æ—¥å¿—å·²ä½œä¸º Artifact ä¸Šä¼ ï¼šbuild_errors ---\n" >> $GITHUB_STEP_SUMMARY

    - name: Upload Error Log Artifact
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build_errors
        path: build_log.txt
        retention-days: 1
        
    - name: Package and upload Termux binary
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: cyber_lookup_termux_aarch64
        path: target/aarch64-linux-android/release/cyber_lookup
        retention-days: 7