name: Rust Cross-Compilation for Termux (AArch64)

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build_termux:
    name: Build for Termux (AArch64)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain and target
      uses: dtolnay/rust-toolchain@stable
      with: {targets: aarch64-linux-android}
        
    # ----------------------------------------------------
    # æ ¸å¿ƒæ„å»ºæ­¥éª¤ï¼šæ•è·æ—¥å¿—å¹¶å…è®¸æµç¨‹ç»§ç»­
    # ----------------------------------------------------
    - name: Build Rust binary for Termux (Release) using Cross
      id: build_step
      # æ•è·æ—¥å¿—åˆ° build_log.txt æ–‡ä»¶ï¼Œå¹¶å…è®¸åœ¨å¤±è´¥æ—¶ç»§ç»­
      run: |
        cross build --release --target aarch64-linux-android 2>&1 | tee build_log.txt
      continue-on-error: true

    # ----------------------------------------------------
    # è‡ªåŠ¨æ—¥å¿—åˆ†æå’Œæ€»ç»“ (åªåœ¨æ„å»ºå¤±è´¥æ—¶è¿è¡Œ)
    # ----------------------------------------------------
    - name: Summarize and Highlight Errors (Automated Analysis)
      # æ¡ä»¶åˆ¤æ–­ï¼šä»…å½“å‰ä¸€æ­¥éª¤ (id: build_step) å¤±è´¥æ—¶è¿è¡Œ
      if: steps.build_step.outcome == 'failure'
      run: |
        echo "--- ğŸš¨ äº¤å‰ç¼–è¯‘é”™è¯¯æ‘˜è¦ ğŸš¨ ---" >> $GITHUB_STEP_SUMMARY
        echo "## é‡ç‚¹é”™è¯¯æç‚¼" >> $GITHUB_STEP_SUMMARY
        
        # è¿è¡Œé«˜æ•ˆçš„ grep è¿‡æ»¤å‘½ä»¤ï¼Œé™åˆ¶è¾“å‡ºè¡Œæ•°ï¼Œå¹¶æ ¼å¼åŒ–è¾“å‡ºåˆ° Summary é¡µé¢
        grep -E 'error:|note:|failed:|cannot find|undefined reference|linker|collect2|aarch64-linux-android' build_log.txt \
        | head -n 50 \
        | sed 's/^/- /' \
        >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "--- å®Œæ•´é”™è¯¯æ—¥å¿—å·²ä½œä¸º Artifact ä¸Šä¼ ï¼šbuild_errors ---" >> $GITHUB_STEP_SUMMARY

    # ----------------------------------------------------
    # ä¸Šä¼ å®Œæ•´çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶ï¼Œæ–¹ä¾¿åç»­ä¸‹è½½
    # ----------------------------------------------------
    - name: Upload Error Log Artifact
      if: steps.build_step.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: build_errors
        path: build_log.txt
        retention-days: 1
        
    # ----------------------------------------------------
    # âœ… æœ€ç»ˆä¿®å¤ï¼šä½¿ç”¨ä¸´æ—¶ç›®å½•ç¡®ä¿ Artifact ä¸Šä¼ æˆåŠŸ
    # ----------------------------------------------------
    - name: Stage Final Binary
      if: steps.build_step.outcome == 'success'
      run: |
        echo "Copying binary to staging directory..."
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•ç”¨äºæ‰“åŒ…
        mkdir -p artifact_staging
        # æ˜ç¡®å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        cp target/aarch64-linux-android/release/cyber_lookup artifact_staging/
      
    - name: Upload Final Binary Artifact
      if: steps.build_step.outcome == 'success'
      uses: actions/upload-artifact@v4
      with: 
        name: cyber_lookup_termux_aarch64
        # ä¸Šä¼ ä¸´æ—¶ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
        path: artifact_staging/*
        retention-days: 7
