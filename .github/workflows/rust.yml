name: Rust Cross-Compilation for Termux (AArch64)

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build_termux:
    name: Build for Termux (AArch64)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain and target
      uses: dtolnay/rust-toolchain@stable
      with: {targets: aarch64-linux-android}
        
    # -----------------------------------------------------
    # 移除手动安装 NDK 和设置环境变量的步骤，避免链接器冲突
    # -----------------------------------------------------
    
    - name: Build Rust binary for Termux (Release) using Cross
      # 保留 actions-rs/cargo 动作并启用 cross
      uses: actions-rs/cargo@v1
      with:
        command: build
        args: --release --target aarch64-linux-android
        use-cross: true 
      env:
        # 强制使用 "abort" panic 策略，这是解决 'cannot find -lunwind' 链接错误的权威方法。
        RUSTFLAGS: "-C panic=abort" 
        
    - name: Package and upload Termux binary
      uses: actions/upload-artifact@v4
      with: {name: cyber_lookup_termux_aarch64, path: target/aarch64-linux-android/release/cyber_lookup, retention-days: 7}
