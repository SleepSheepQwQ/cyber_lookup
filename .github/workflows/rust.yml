name: Rust Cross-Compilation for Termux (AArch64)

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build_termux:
    name: Build for Termux (AArch64)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain and target
      uses: dtolnay/rust-toolchain@stable
      with: {targets: aarch64-linux-android}
        
    # ----------------------------------------------------
    # ✅ 核心修复：使用 cross install 将二进制文件复制到主机环境的 $HOME/.cargo/bin
    # ----------------------------------------------------
    - name: Build and Install Binary using Cross
      id: build_step
      # cross install 会自动将构建好的 release 二进制文件复制到主机环境的 $HOME/.cargo/bin 目录
      run: |
        # 移除日志捕获，构建失败则直接停止，避免混乱
        cross install --release --target aarch64-linux-android
      # 注意：如果构建失败，流程会在此停止，不会运行后续步骤。
      # build_step 的 id 依然存在，用于后续 if 条件判断。

    # ----------------------------------------------------
    # ✅ 从标准安装路径复制文件到 Artifact 临时目录
    # ----------------------------------------------------
    - name: Stage Final Binary
      # 只有当前面的安装步骤成功时才运行 (implied by no 'continue-on-error')
      if: success()
      run: |
        echo "Copying binary from $HOME/.cargo/bin to staging directory..."
        # 1. 创建一个临时目录用于打包
        mkdir -p artifact_staging
        # 2. 从 cross install 的标准输出路径复制二进制文件
        # 文件名是项目名：cyber_lookup
        cp $HOME/.cargo/bin/cyber_lookup artifact_staging/
        echo "Staging successful."
      
    - name: Upload Final Binary Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with: 
        name: cyber_lookup_termux_aarch64
        # 上传临时目录中的所有文件
        path: artifact_staging/*
        retention-days: 7
