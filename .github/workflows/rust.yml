name: Rust Cross-Compilation for Termux (AArch64) using Cross

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build_termux:
    name: Build using Cross
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain and target
      # dtolnay/rust-toolchain 仍然是安全的标准步骤
      uses: dtolnay/rust-toolchain@stable
      with: {targets: aarch64-linux-android}
        
    - name: Install 'cross'
      # 安装 cross 工具
      run: cargo install cross
      
    - name: Build Rust binary for Termux (Release) using Cross
      # 使用 cross 命令代替 cargo build。cross 会自动在 Docker 容器内进行编译
      # 避免所有 NDK/Linker 环境变量的复杂性。
      run: cross build --release --target aarch64-linux-android
        
    - name: Package and upload Termux binary
      uses: actions/upload-artifact@v4
      with: 
        name: cyber_lookup_termux_aarch64
        # 注意：cross 默认将二进制文件放在 target/aarch64-unknown-linux-gnu/release/
        # 但 Android target 路径是固定的。
        path: target/aarch64-linux-android/release/cyber_lookup 
        retention-days: 7
