name: "CI/CD: AArch64 Cross Build (Final & Cached)"

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build_termux:
    name: "Build and Deploy"
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      # ----------------------------------------------------
      # æ­¥éª¤ 1: ç¼“å­˜ Cargo/Cross ä¾èµ– (è§£å†³ä¸‹è½½ç¹ç)
      # ----------------------------------------------------
      - name: "Cache Cargo/Cross Dependencies"
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin/cross
            target/aarch64-linux-android/release/
            target/debug/
          # ä½¿ç”¨ Cargo.lock æ–‡ä»¶å†…å®¹ä½œä¸º key çš„å“ˆå¸Œå€¼ï¼Œç¡®ä¿ä¾èµ–æ›´æ–°æ—¶ç¼“å­˜å¤±æ•ˆ
          key: ${{ runner.os }}-cargo-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: "Install Rust Toolchain"
        uses: dtolnay/rust-toolchain@stable
        with: {targets: aarch64-linux-android}
        
      - name: "Install Cross Tool (If Not Cached)"
        # ğŸš¨ å…³é”®ä¿®å¤: åŠ å…¥ --force è§£å†³ä¸ç¼“å­˜çš„å†²çªï¼Œç¡®ä¿ cross æˆåŠŸå®‰è£…æˆ–æ›´æ–°ã€‚
        run: cargo install cross --git https://github.com/cross-rs/cross --force

      - name: "Clean and Build Binary"
        # æ ¸å¿ƒæ„å»ºå‘½ä»¤
        run: cross build --release --target aarch64-linux-android
        
      # ----------------------------------------------------
      # æ­¥éª¤ 3: æ‰“åŒ…å¹¶ä¸Šä¼  Artifacts
      # ----------------------------------------------------
      - name: "Upload AArch64 Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: cyber_lookup_aarch64
          # æ„å»ºäº§ç‰©è·¯å¾„
          path: target/aarch64-linux-android/release/cyber_lookup
          # ç¡®ä¿ Artifacts åœ¨å·¥ä½œæµç»“æŸåä¿ç•™ï¼Œä»¥ä¾¿ä¸‹è½½
          retention-days: 7 

