name: Rust Cross-Compilation for Termux (AArch64)

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build_termux:
    name: Build for Termux (AArch64)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain and target
      uses: dtolnay/rust-toolchain@stable
      with: {targets: aarch64-linux-android}
        
    # ----------------------------------------------------
    # 1. 确保 cross 工具本身已安装
    # ----------------------------------------------------
    - name: Install Cross Tool
      run: cargo install cross
        
    # ----------------------------------------------------
    # 2. 核心构建步骤：使用 cross install 确保二进制文件导出到主机 $HOME/.cargo/bin
    # ----------------------------------------------------
    - name: Build and Install Binary using Cross
      id: build_step
      run: |
        # 使用 install 命令，如果构建成功，二进制文件会被复制到主机环境的 $HOME/.cargo/bin 目录
        cross install --release --target aarch64-linux-android

    # ----------------------------------------------------
    # 3. 从标准安装路径复制文件到 Artifact 临时目录
    # ----------------------------------------------------
    - name: Stage Final Binary
      if: success()
      run: |
        echo "Copying binary from $HOME/.cargo/bin to staging directory..."
        mkdir -p artifact_staging
        # 文件名是项目名：cyber_lookup
        cp $HOME/.cargo/bin/cyber_lookup artifact_staging/
        echo "Staging successful."
      
    - name: Upload Final Binary Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with: 
        name: cyber_lookup_termux_aarch64
        path: artifact_staging/*
        retention-days: 7
