name: Rust Cross-Compilation for Termux (AArch64)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build_termux:
    name: Build for Termux (AArch64)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain and target
      uses: dtolnay/rust-toolchain@stable
      with: {targets: aarch64-linux-android}
        
    # ----------------------------------------------------
    # 核心构建步骤：强制清除并构建 (解决假性成功问题)
    # ----------------------------------------------------
    - name: Clean and Build Rust binary using Cross
      id: build_step
      run: |
        echo "Forcing a clean build to bypass potential caching/skip issues."
        # ⚠️ 关键修正 1: 强制清除 target 目录，确保是完整的重新编译
        cross clean --target aarch64-linux-android
        
        # ⚠️ 关键修正 2: 使用 -vvv (非常详细) 打印日志，并捕获到 build_log.txt
        # -vvv 可以揭示 rusqlite 等依赖的 build.rs 脚本的详细输出。
        cross build --release --target aarch64-linux-android -vvv 2>&1 | tee build_log.txt
      continue-on-error: true

    # ----------------------------------------------------
    # 验证步骤：检查可执行文件是否存在
    # ----------------------------------------------------
    - name: Debug: Check for Binary Existence
      run: |
        FINAL_PATH="target/aarch64-linux-android/release/cyber_lookup"
        
        echo "Listing contents of target/aarch64-linux-android/release/:"
        ls -lR target/aarch64-linux-android/release/
        
        if [ -f "$FINAL_PATH" ]; then
          echo "✅ Binary found at: $FINAL_PATH"
        else
          echo "❌ Binary NOT found at expected path: $FINAL_PATH"
          echo "The build was likely skipped or failed to output the file. Review the full build_log.txt."
          # 强制让这个步骤失败，阻止后续上传空文件
          exit 1 
        fi

    # ----------------------------------------------------
    # 日志和上传步骤
    # ----------------------------------------------------
    - name: Summarize and Highlight Errors (Automated Analysis)
      if: failure()
      run: |
        # ... (此处省略日志分析代码，与之前版本保持一致) ...

    - name: Upload Error Log Artifact
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build_errors
        path: build_log.txt
        retention-days: 1
        
    - name: Package and upload Termux binary
      # 仅在所有前序步骤成功时上传 (因此不需要 if: steps.build_step.outcome == 'success')
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: cyber_lookup_termux_aarch64
        path: target/aarch64-linux-android/release/cyber_lookup
        retention-days: 7
