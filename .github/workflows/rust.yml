# .github/workflows/rust.yml
name: Rust Cross-Compilation for Termux (AArch64)

on:
  push:
    # 监听主分支 'master'
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build_termux:
    name: Build for Termux (AArch64)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain and target
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-linux-android
        
    - name: Setup Android NDK
      # 保持指定版本，尽管 Actions 可能自动回退，但我们确保路径定义能适应 NDK 结构
      uses: android-actions/setup-android@v3
      with:
        ndk: '25.1.8937393' 
        
    - name: Set NDK Environment Variables (FINAL FIX - Using NDK-Toolchain Path)
      run: |
        # 1. 定义 NDK 工具链路径
        # $ANDROID_NDK_HOME 变量由 setup-android Action 自动设置
        NDK_BIN=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin
        
        # 2. 定义具体的工具名 (使用交叉编译的标准三元组命名)
        # 注意：使用 aarch64-linux-android29 是为了兼容rusqlite/cc-rs对老工具链名的依赖
        CLANG_TOOL="${NDK_BIN}/aarch64-linux-android29-clang"
        CLANGXX_TOOL="${NDK_BIN}/aarch64-linux-android29-clang++"
        # 这是 Archiver 工具，解决最后一次失败 (No such file or directory) 的关键
        AR_TOOL="${NDK_BIN}/aarch64-linux-android-ar"
        
        # 3. 【终极修复：设置所有交叉编译工具链】
        
        # A. 修复 Archiver (AR) 路径
        echo "AR=${AR_TOOL}" >> $GITHUB_ENV
        echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_AR=${AR_TOOL}" >> $GITHUB_ENV
        
        # B. 修复 C/C++ 编译器 (CC/CXX) 路径
        echo "CC_AARCH64_LINUX_ANDROID=${CLANG_TOOL}" >> $GITHUB_ENV
        echo "CXX_AARCH64_LINUX_ANDROID=${CLANGXX_TOOL}" >> $GITHUB_ENV
        echo "CC=${CLANG_TOOL}" >> $GITHUB_ENV
        echo "CXX=${CLANGXX_TOOL}" >> $GITHUB_ENV
        
        # C. 设置链接器路径 (LINKER)
        echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=${CLANG_TOOL}" >> $GITHUB_ENV

    # --- 编译步骤 ---
    - name: Build Rust binary for Termux (Release)
      run: |
        cargo build --release --target aarch64-linux-android
        
    - name: Package and upload Termux binary
      uses: actions/upload-artifact@v4
      with:
        name: cyber_lookup_termux_aarch64
        path: target/aarch64-linux-android/release/cyber_lookup 
        retention-days: 7
