name: Rust Cross-Compilation for Termux (AArch64)

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build_termux:
    name: Build for Termux (AArch64)
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust toolchain and target
      uses: dtolnay/rust-toolchain@stable
      with: {targets: aarch64-linux-android}
        
    # ----------------------------------------------------
    # æ ¸å¿ƒæ„å»ºæ­¥éª¤ï¼šä½¿ç”¨ cross buildï¼Œå¹¶æ•è·æ—¥å¿—
    # ----------------------------------------------------
    - name: Build Rust binary for Termux (Release) using Cross
      id: build_step
      # æ•è·æ—¥å¿—åˆ° build_log.txt æ–‡ä»¶ï¼Œå¹¶å…è®¸åœ¨å¤±è´¥æ—¶ç»§ç»­
      run: |
        # ä½¿ç”¨ cross build å‘½ä»¤ï¼Œè®© cross è‡ªåŠ¨ç®¡ç† NDK é“¾æ¥å™¨
        cross build --release --target aarch64-linux-android 2>&1 | tee build_log.txt
      continue-on-error: true

    # ----------------------------------------------------
    # è‡ªåŠ¨æ—¥å¿—åˆ†æå’Œæ€»ç»“ (åªåœ¨æ„å»ºå¤±è´¥æ—¶è¿è¡Œ)
    # ----------------------------------------------------
    - name: Summarize and Highlight Errors (Automated Analysis)
      if: steps.build_step.outcome == 'failure'
      run: |
        echo "--- ğŸš¨ äº¤å‰ç¼–è¯‘é”™è¯¯æ‘˜è¦ ğŸš¨ ---" >> $GITHUB_STEP_SUMMARY
        echo "## é‡ç‚¹é”™è¯¯æç‚¼" >> $GITHUB_STEP_SUMMARY
        
        # è¿è¡Œé«˜æ•ˆçš„ grep è¿‡æ»¤å‘½ä»¤ï¼Œæç‚¼å…³é”®é”™è¯¯ä¿¡æ¯
        grep -E 'error:|note:|failed:|cannot find|undefined reference|linker|collect2|aarch64-linux-android' build_log.txt \
        | head -n 50 \
        | sed 's/^/- /' \
        >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "--- å®Œæ•´é”™è¯¯æ—¥å¿—å·²ä½œä¸º Artifact ä¸Šä¼ ï¼šbuild_errors ---" >> $GITHUB_STEP_SUMMARY

    # ----------------------------------------------------
    # ä¸Šä¼ å®Œæ•´çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶ï¼Œæ–¹ä¾¿åç»­ä¸‹è½½
    # ----------------------------------------------------
    - name: Upload Error Log Artifact
      if: steps.build_step.outcome == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: build_errors
        path: build_log.txt
        retention-days: 1
        
    - name: Package and upload Termux binary
      # ä»…åœ¨æ„å»ºæˆåŠŸæ—¶ä¸Šä¼ 
      if: steps.build_step.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: cyber_lookup_termux_aarch64
        # æ³¨æ„ï¼šè·¯å¾„æ˜¯ target/TARGET/release/BINARY_NAME
        path: target/aarch64-linux-android/release/cyber_lookup
        retention-days: 7
